@if (displayedTickets.length > 0) {

  <div class="row pt-5 g-4">

    @for (ticket of sortedTickets; track ticket.pnr) {
      <div class="col-md-6">
        <div class="ticket-card">

          <!-- Header -->
          <div class="ticket-header">
            <h5 class="mb-0">
              {{ ticket.origin }}
              <span class="text-muted mx-2">→</span>
              {{ ticket.destination }}
            </h5>

            <span
              class="status-badge"
              [class.booked]="ticket.booked"
              [class.cancelled]="!ticket.booked">
              {{ ticket.booked ? 'Booked' : 'Cancelled' }}
            </span>
          </div>

          <!-- PNR -->
          <div class="pnr">
            PNR:
            <span>{{ ticket.pnr }}</span>
          </div>

          <div class="ticket-divider"></div>

          <!-- Timing -->
          <div class="ticket-details">
            <div>
              <small>Departure</small>
              <p>{{ ticket.departureTime | date:'dd MMM yyyy, hh:mm a' }}</p>
            </div>

            <div>
              <small>Arrival</small>
              <p>{{ ticket.arrivalTime | date:'dd MMM yyyy, hh:mm a' }}</p>
            </div>
          </div>

          <div class="ticket-divider"></div>

          <!-- Passengers -->
          <div class="passengers">
            <small class="text-muted">Passengers</small>

            @for (p of ticket.passengers; track p.email) {
              <div class="passenger">
                <strong>{{ p.name }}</strong>
                <div class="text-muted small">
                  {{ p.email }} · {{ p.phoneNum }}
                </div>
              </div>
            }
          </div>

          <div class="ticket-divider"></div>

          <!-- Footer -->
          <div class="ticket-footer">
            <span class="seats">
              Seats: {{ ticket.numberOfSeats }}
            </span>

            @if (ticket.seatNumbers && ticket.seatNumbers.length) {
              <span class="text-muted small ms-2">
                ({{ ticket.seatNumbers.join(', ') }})
              </span>
            }

            @if (ticket.booked && !isCancelDisabled(ticket)) {
              <button
                class="btn btn-danger btn-sm"
                (click)="openCancelModal(ticket)">
                Cancel Ticket
              </button>
            }
          </div>

        </div>
      </div>

    }

  </div>

} @else {
  <div class="text-center text-muted mt-5">
    No tickets found
  </div>
}

<!-- Cancel Confirmation Modal -->
@if (selectedTicket) {
  <div class="modal-backdrop fade show " style="display: block;"></div>
  <div class="modal fade show my-5" style="display: block;">
    <div class="modal-dialog my-5">
      <div class="modal-content ">
        <div class="modal-header">
          <h5 class="modal-title">Cancel Ticket</h5>
          <button 
            type="button" 
            class="btn-close" 
            (click)="closeModal()"
            [disabled]="isCancelling">
          </button>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to cancel this ticket?</p>
          <div class="alert alert-info">
            <strong>{{ selectedTicket.origin }} → {{ selectedTicket.destination }}</strong><br>
            PNR: {{ selectedTicket.pnr }}<br>
            Departure: {{ selectedTicket.departureTime | date:'dd MMM yyyy, hh:mm a' }}
          </div>
          <p class="text-muted">This action cannot be undone.</p>
        </div>
        <div class="modal-footer">
          <button 
            type="button" 
            class="btn btn-secondary" 
            (click)="closeModal()"
            [disabled]="isCancelling">
            Keep Ticket
          </button>
          <button 
            type="button" 
            class="btn btn-danger" 
            (click)="confirmCancel(selectedTicket)"
            [disabled]="isCancelling">
            @if (isCancelling) {
              <span class="spinner-border spinner-border-sm me-2"></span>
              Cancelling...
            } @else {
              Confirm Cancellation
            }
          </button>
        </div>
      </div>
    </div>
  </div>
}
